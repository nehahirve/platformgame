const container = document.getElementById('container')

/*
--------------------------------
GAME CONSTANTS AND HELPERS
--------------------------------
*/

const LEVELS = [`                                                    
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
..................................................................###...........
...................................................##......##....##+##..........
....................................o.o......##..................#+++#..........
.................................................................##+##..........
...................................#####..........................#v#...........
............................................................................##..
..##......................................o.o................................#..
..#.....................o....................................................#..
..#......................................#####.............................o.#..
..#..........####.......o....................................................#..
..#..@.......#..#................................................#####.......#..
..############..###############...####################.....#######...#########..
..............................#...#..................#.....#....................
..............................#+++#..................#+++++#....................
..............................#+++#..................#+++++#....................
..............................#####..................#######....................
................................................................................
................................................................................
`, `                                                                     
................................................................................
................................................................................
....###############################.............................................
...##.............................##########################################....
...#.......................................................................##...
...#....o...................................................................#...
...#................................................=.......................#...
...#.o........################...................o..o...........|........o..#...
...#.........................#..............................................#...
...#....o....................##########.....###################....##########...
...#..................................#+++++#.................#....#............
...###############....oo......=o.o.o..#######.###############.#....#............
.....#...............o..o.............#.......#......#........#....#............
.....#....................#############..######.####.#.########....########.....
.....#.............########..............#...........#.#..................#.....
.....#..........####......####...#####################.#..................#.....
.....#........###............###.......................########....########.....
.....#.......##................#########################......#....#............
.....#.......#................................................#....#............
.....###......................................................#....#............
.......#...............o...........................................#............
.......#...............................................o...........#............
.......#########......###.....############.........................##...........
.............#..................#........#####....#######.o.........########....
.............#++++++++++++++++++#............#....#.....#..................#....
.............#++++++++++++++++++#..........###....###...####.o.............#....
.............####################..........#........#......#.....|.........#....
...........................................#++++++++#......####............#....
...........................................#++++++++#.........#........@...#....
...........................................#++++++++#.........##############....
...........................................##########...........................
................................................................................
`, `
......................................#++#........................#######....................................#+#..
......................................#++#.....................####.....####.................................#+#..
......................................#++##########...........##...........##................................#+#..
......................................##++++++++++##.........##.............##...............................#+#..
.......................................##########++#.........#....................................o...o...o..#+#..
................................................##+#.........#.....o...o....................................##+#..
.................................................#+#.........#................................###############++#..
.................................................#v#.........#.....#...#........................++++++++++++++##..
.............................................................##..|...|...|..##............#####################...
..............................................................##+++++++++++##............v........................
...............................................................####+++++####......................................
...............................................#.....#............#######........###.........###..................
...............................................#.....#...........................#.#.........#.#..................
...............................................#.....#.............................#.........#....................
...............................................#.....#.............................##........#....................
...............................................##....#.............................#.........#....................
...............................................#.....#......o..o.....#...#.........#.........#....................
...............#######........###...###........#.....#...............#...#.........#.........#....................
..............##.....##.........#...#..........#.....#.....######....#...#...#########.......#....................
.............##.......##........#.o.#..........#....##...............#...#...#...............#....................
.....@.......#.........#........#...#..........#.....#...............#...#...#...............#....................
....###......#.........#........#...#..........#.....#...............#...#####...######......#....................
....#.#......#.........#.......##.o.##.........#.....#...............#.....o.....#.#.........#....................
++++#.#++++++#.........#++++++##.....##++++++++##....#++++++++++.....#.....=.....#.#.........#....................
++++#.#++++++#.........#+++++##.......##########.....#+++++++##+.....#############.##..o.o..##....................
++++#.#++++++#.........#+++++#....o.................##++++++##.+....................##.....##.....................
++++#.#++++++#.........#+++++#.....................##++++++##..+.....................#######......................
++++#.#++++++#.........#+++++##.......##############++++++##...+..................................................
++++#.#++++++#.........#++++++#########++++++++++++++++++##....+..................................................
++++#.#++++++#.........#++++++++++++++++++++++++++++++++##.....+..................................................
`, `
..............................................................................................................
..............................................................................................................
..............................................................................................................
..............................................................................................................
..............................................................................................................
........................................o.....................................................................
..............................................................................................................
........................................#.....................................................................
........................................#.....................................................................
........................................#.....................................................................
........................................#.....................................................................
.......................................###....................................................................
.......................................#.#.................+++........+++..###................................
.......................................#.#.................+#+........+#+.....................................
.....................................###.###................#..........#......................................
......................................#...#.................#...oooo...#.......###............................
......................................#...#.................#..........#......#+++#...........................
......................................#...#.................############.......###............................
.....................................##...##......#...#......#................................................
......................................#...#########...########..............#.#...............................
......................................#...#...........#....................#+++#..............................
......................................#...#...........#.....................###...............................
.....................................##...##..........#.......................................................
......................................#...#=.=.=.=....#............###........................................
......................................#...#...........#...........#+++#.......................................
......................................#...#....=.=.=.=#.....o......###.......###..............................
.....................................##...##..........#.....................#+++#.............................
..............................o...o...#...#...........#.....#................##v........###...................
......................................#...#...........#..............#.................#+++#..................
.............................###.###.###.###.....o.o..#++++++++++++++#...................v#...................
.............................#.###.#.#.###.#..........#++++++++++++++#........................................
.............................#.............#...#######################........................................
.............................##...........##.........................................###......................
..###.........................#.....#.....#.........................................#+++#................###..
..#.#.........................#....###....#..........................................###.................#.#..
..#...........................#....###....#######........................#####.............................#..
..#...........................#...........#..............................#...#.............................#..
..#...........................##..........#..............................#.#.#.............................#..
..#.......................................#.......|####|....|####|.....###.###.............................#..
..#................###.............o.o....#..............................#.........###.....................#..
..#...............#####.......##..........#.............................###.......#+++#..........#.........#..
..#...............o###o.......#....###....#.............................#.#........###..........###........#..
..#................###........#############..#.oo.#....#.oo.#....#.oo..##.##....................###........#..
..#......@..........#.........#...........#++#....#++++#....#++++#....##...##....................#.........#..
..#############################...........#############################.....################################..
..............................................................................................................
..............................................................................................................
`, `
..................................................................................................###.#.......
......................................................................................................#.......
..................................................................................................#####.......
..................................................................................................#...........
..................................................................................................#.###.......
..........................o.......................................................................#.#.#.......
.............................................................................................o.o.o###.#.......
...................###................................................................................#.......
.......+..o..+................................................#####.#####.#####.#####.#####.#####.#####.......
.......#.....#................................................#...#.#...#.#...#.#...#.#...#.#...#.#...........
.......#=.o..#............#...................................###.#.###.#.###.#.###.#.###.#.###.#.#####.......
.......#.....#..................................................#.#...#.#...#.#...#.#...#.#...#.#.....#.......
.......+..o..+............o..................................####.#####.#####.#####.#####.#####.#######.......
..............................................................................................................
..........o..............###..............................##..................................................
..............................................................................................................
..............................................................................................................
......................................................##......................................................
...................###.........###............................................................................
..............................................................................................................
..........................o.....................................................#......#......................
..........................................................##.....##...........................................
.............###.........###.........###.................................#..................#.................
..............................................................................................................
.................................................................||...........................................
..###########.................................................................................................
..#.........#.o.#########.o.#########.o.##................................................#...................
..#.........#...#.......#...#.......#...#.................||..................#.....#.........................
..#..@......#####...o...#####...o...#####.....................................................................
..#######.....................................#####.......##.....##.....###...................................
........#=..................=................=#...#.....................###...................................
........#######################################...#+++++++++++++++++++++###+++++++++++++++++++++++++++++++++++
..................................................############################################################
..............................................................................................................
`]

const gravity = 30
const playerXSpeed = 7
const jumpSpeed = 17
const scale = 20

const wobbleSpeed = 8
const wobbleDist = 0.07

class Vec {
  constructor (x, y) {
    this.x = x
    this.y = y
  }

  plus (vector) {
    return new Vec(this.x + vector.x, this.y + vector.y)
  }

  times (factor) {
    return new Vec(this.x * factor, this.y * factor)
  }
}

function elt (name, attrs, ...children) {
  const dom = document.createElement(name)

  for (const attr in attrs) {
    dom.setAttribute(attr, attrs[attr])
  }

  for (const child of children) {
    dom.appendChild(child)
  }

  return dom
}

/*
--------------------------------
ACTORS
--------------------------------
*/

class Lava {
  constructor (pos, speed, reset) {
    this.pos = pos
    this.speed = speed
    this.reset = reset
  }

  get type () {
    return 'lava'
  }

  static create (pos, ch) {
    if (ch === 'v') {
      return new Lava(pos, new Vec(0, 3), pos)
    } else if (ch === '|') {
      return new Lava(pos, new Vec(0, 2))
    } else if (ch === '=') {
      return new Lava(pos, new Vec(2, 0))
    }
  }

  collide (state) {
    return new State(state.level, state.actors, 'lost')
  }

  update (timestep, state) {
    const newPos = this.pos.plus(this.speed.times(timestep))
    if (!state.level.touching(newPos, this.size, 'wall')) {
      return new Lava(newPos, this.speed, this.reset)
    } else if (this.reset) {
      return new Lava(this.reset, this.speed, this.reset)
    } else {
      return new Lava(this.pos, this.speed.times(-1))
    }
  }
}

Lava.prototype.size = new Vec(1, 1)

class Coin {
  constructor (pos, basePos, wobble) {
    this.pos = pos
    this.basePos = basePos
    this.wobble = wobble
  }

  get type () {
    return 'coin'
  }

  static create (pos) {
    const basePos = pos.plus(new Vec(0.2, 0.2))
    return new Coin(basePos, basePos, Math.random(Math.PI * 2))
  }

  collide (state) {
    const filtered = state.actors.filter(actor => actor !== this)
    let status = state.status
    if (!filtered.some(actor => actor.type === 'coin')) {
      status = 'won'
    }
    return new State(state.level, filtered, status)
  }

  update (timestep) {
    const newWobble = this.wobble + wobbleSpeed * timestep
    const wobblePos = Math.sin(newWobble) * wobbleDist
    return new Coin(this.pos.plus(new Vec(0, wobblePos)), this.basePos, newWobble)
  }
}

Coin.prototype.size = new Vec(0.6, 0.6)

class Player {
  constructor (pos, speed) {
    this.pos = pos
    this.speed = speed
  }

  get type () {
    return 'player'
  }

  static create (pos) {
    return new Player(pos.plus(new Vec(0.05, -0.5)), new Vec(0, 0))
  }

  update (timestep, state, keys) {
    let xSpeed = 0
    if (keys.ArrowLeft) {
      xSpeed -= playerXSpeed
    }
    if (keys.ArrowRight) {
      xSpeed += playerXSpeed
    }
    let pos = this.pos
    const movedX = pos.plus(new Vec(timestep * xSpeed, 0))
    if (!state.level.touching(movedX, this.size, 'wall')) {
      pos = movedX
    }

    let ySpeed = this.speed.y + gravity * timestep
    const movedY = pos.plus(new Vec(0, timestep * ySpeed))
    if (!state.level.touching(movedY, this.size, 'wall')) {
      pos = movedY
    } else if (keys.ArrowUp && ySpeed > 0) {
      ySpeed = -jumpSpeed
    } else {
      ySpeed = 0
    }
    return new Player(pos, new Vec(xSpeed, ySpeed))
  }
}

Player.prototype.size = new Vec(0.8, 1.5)

/*
--------------------------------
LEVELS AND STATE
--------------------------------
*/
const levelChars = {
  '.': 'empty',
  '#': 'wall',
  o: Coin,
  '@': Player,
  '=': Lava,
  v: Lava,
  '|': Lava,
  '+': 'lava'
}

class Level {
  constructor (plan) {
    const rows = plan.trim().split('\n').map(row => [...row])
    this.width = rows[0].length
    this.height = rows.length
    this.startActors = []

    this.rows = rows.map((row, y) => {
      return row.map((ch, x) => {
        const type = levelChars[ch]
        if (typeof type === 'string') {
          return type
        }
        this.startActors.push(type.create(new Vec(x, y), ch))
        return 'empty'
      })
    })
  }

  touching (actorpos, actorsize, type) {
    const startX = Math.floor(actorpos.x)
    const endX = Math.ceil(actorpos.x + actorsize.x)
    const startY = Math.floor(actorpos.y)
    const endY = Math.ceil(actorpos.y + actorsize.y)

    for (let y = startY; y < endY; y++) {
      for (let x = startX; x < endX; x++) {
        const isOutside = x < 0 || x >= this.width ||
          y < 0 || y >= this.height
        const here = isOutside ? 'wall' : this.rows[y][x]
        if (here === type) {
          return true
        }
      }
    }
    return false
  }
}

class State {
  constructor (level, actors, status) {
    this.level = level
    this.actors = actors
    this.status = status
  }

  get player () {
    return this.actors.find(actor => actor.type === 'player')
  }

  static start (level) {
    return new State(level, level.startActors, 'playing')
  }

  update (timestep, keys) {
    const actors = this.actors.map(actor => actor.update(timestep, this, keys))
    let newState = new State(this.level, actors, this.status)

    const player = newState.player

    if (newState.level.touching(player.pos, player.size, 'lava')) {
      return new State(this.level, actors, 'lost')
    }

    for (const actor of actors) {
      if (actor.type !== 'player' && overlap(actor, player)) {
        newState = actor.collide(newState)
      }
    }

    return newState
  }
}

function overlap (actor1, actor2) {
  return actor1.pos.x + actor1.size.x > actor2.pos.x &&
    actor1.pos.x < actor2.pos.x + actor2.size.x &&
    actor1.pos.y + actor1.size.y > actor2.pos.y &&
    actor1.pos.y < actor2.pos.y + actor2.size.y
}

/*
--------------------------------
DOM DISPLAY MODULE
--------------------------------
*/
class DOMDisplay {
  constructor (parent, level) {
    this.dom = elt('div', { class: 'game' }, drawGrid(level))
    this.actorLayer = null
    parent.appendChild(this.dom)
  }

  clear () {
    this.dom.remove()
  }

  syncState (state) {
    if (this.actorLayer) this.actorLayer.remove()
    this.actorLayer = drawActors(state.actors)
    this.dom.className = `game ${state.status}` // set status class for won and lost
    this.scrollPlayerIntoView(state)
    this.dom.appendChild(this.actorLayer)
  }

  scrollPlayerIntoView (state) {
    const width = this.dom.clientWidth
    const height = this.dom.clientHeight
    const margin = width / 3

    const left = this.dom.scrollLeft
    const right = left + width
    const top = this.dom.scrollTop
    const bottom = top + height

    const player = state.player
    const center = player.pos.plus(player.size.times(0.5)).times(scale)

    if (center.x < left + margin) {
      this.dom.scrollLeft = center.x - margin
    } else if (center.x > right - margin) {
      this.dom.scrollLeft = center.x - width + margin
    }
    if (center.y < top + margin) {
      this.dom.scrollTop = center.y - margin
    } else if (center.y > bottom - margin) {
      this.dom.scrollTop = center.y - height + margin
    }
  }
}

// create grid element

function drawGrid (level) {
  return elt('table', {
    class: 'background',
    style: `width: ${level.width * scale}px`
  }, ...level.rows.map(row => {
    return elt('tr', {
      style: `height: ${scale}px`
    }, ...row.map(cell => {
      return elt('td', {
        class: cell
      })
    }))
  }))
}

// create actor layer element

function drawActors (actors) {
  return elt('div', {}, ...actors.map(actor => {
    const rect = elt('div', {
      class: `actor ${actor.type}`
    })
    rect.style.width = `${actor.size.x * scale}px`
    rect.style.height = `${actor.size.y * scale}px`
    rect.style.left = `${actor.pos.x * scale}px`
    rect.style.top = `${actor.pos.y * scale}px`

    if (actor.type === 'player' && actor.speed.x > 0) {
      rect.className = `actor ${actor.type} skewleft`
    }
    if (actor.type === 'player' && actor.speed.x < 0) {
      rect.className = `actor ${actor.type} skewright`
    }

    return rect
  }))
}

/*
--------------------------------
KEYTRACKING
--------------------------------
*/
function trackKeys (keys) {
  const down = Object.create(null)

  function track (event) {
    if (keys.includes(event.key)) {
      down[event.key] = event.type === 'keydown'
      event.preventDefault()
    }
  }

  window.addEventListener('keydown', track)
  window.addEventListener('keyup', track)
  return down
}

const arrowKeys = trackKeys(['ArrowLeft', 'ArrowRight', 'ArrowUp'])

/*
--------------------------------
ANIMATING
--------------------------------
*/

function runAnimation (conditionFunc) {
  let lastTime = null

  function frame (timestamp) {
    if (lastTime !== null) {
      const timeStep = Math.min(100, timestamp - lastTime) / 1000
      if (conditionFunc(timeStep) === false) {
        return
      }
    }
    lastTime = timestamp
    requestAnimationFrame(frame)
  }

  requestAnimationFrame(frame)
}

function runLevel (level, Display) {
  let state = State.start(level)
  const display = new Display(container, level)
  let end = 1

  return new Promise(resolve => {
    runAnimation(time => {
      state = state.update(time, arrowKeys)
      display.syncState(state)

      if (state.status === 'playing') {
        return true
      } else if (end > 0) {
        end -= time
      } else {
        display.clear()
        resolve(state.status)
        return false
      }
    })
  })
}

async function runGame (levelplans, Display) {
  for (let level = 0; level < levelplans.length;) {
    const status = await runLevel(new Level(levelplans[level]), Display)
    if (status === 'won') {
      level++
    }
  }

  console.log('You have beaten all the levels')
}

// plugging it all in

runGame(LEVELS, DOMDisplay)
